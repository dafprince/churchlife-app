<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Complet - R√©cup√©ration des Audios Backend vers Mobile</title>
    <style>
        @media print {
            body { margin: 0; }
            .page-break { page-break-after: always; }
            .no-print { display: none; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #764ba2;
            margin-top: 30px;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(90deg, #f3f0ff 0%, transparent 100%);
            border-left: 4px solid #667eea;
        }
        
        h3 {
            color: #374151;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .error-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            color: #dc2626;
            font-size: 0.9em;
        }
        
        pre code {
            background: none;
            color: #e5e7eb;
            padding: 0;
        }
        
        .folder-structure {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .step-box {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .step-number {
            background: #0ea5e9;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        .flow-diagram {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .flow-arrow {
            color: #667eea;
            font-size: 1.5rem;
            margin: 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f3f4f6;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ GUIDE COMPLET : R√©cup√©ration des Audios Backend vers Mobile Flutter</h1>
        
        <div class="info-box">
            <strong>Objectif :</strong> Cr√©er un syst√®me complet pour afficher et lire des audios stock√©s sur un backend Node.js dans une application mobile Flutter avec lecteur audio int√©gr√© style Kanguka.
        </div>

        <h2>üìã 1. CONTEXTE ET PR√âREQUIS</h2>
        
        <h3>Structure Backend Existante</h3>
        <pre><code>// Mod√®le MongoDB - Audio.js
const AudioSchema = new mongoose.Schema({
  // Informations de base
  titre: { type: String, required: true },
  artiste: { type: String, required: true },
  album: { type: String, default: '' },
  genre: { type: String, default: '' },
  description: { type: String, default: '' },
  
  // Fichier audio
  audioFileName: { type: String, required: true },
  audioPath: { type: String, required: true },
  audioSize: { type: Number, required: true },
  duration: { type: Number, default: 0 },
  
  // Image de couverture
  imageFileName: { type: String, required: true },
  imagePath: { type: String, required: true },
  
  // M√©tadonn√©es
  uploadedBy: { type: ObjectId, ref: 'User' },
  uploadedAt: { type: Date, default: Date.now },
  playCount: { type: Number, default: 0 },
  isActive: { type: Boolean, default: true }
});</code></pre>

        <h3>Routes Backend Disponibles</h3>
        <ul>
            <li><code>GET /api/audios</code> - R√©cup√©rer tous les audios actifs</li>
            <li><code>POST /api/audios/upload</code> - Upload audio + image</li>
            <li><code>DELETE /api/audios/:id</code> - Supprimer un audio</li>
        </ul>

        <h3>Configuration Multer</h3>
        <ul>
            <li><strong>Audios :</strong> <code>uploads/audios/</code></li>
            <li><strong>Images :</strong> <code>uploads/images/</code></li>
            <li><strong>Formats accept√©s :</strong> MP3, WAV, OGG + JPG, PNG</li>
        </ul>

        <h2>üèóÔ∏è 2. ARCHITECTURE MOBILE FLUTTER</h2>
        
        <div class="folder-structure">
features/
  ‚îî‚îÄ‚îÄ audios/
       ‚îú‚îÄ‚îÄ data/
       ‚îÇ    ‚îú‚îÄ‚îÄ datasources/
       ‚îÇ    ‚îÇ     ‚îî‚îÄ‚îÄ audio_api_service.dart
       ‚îÇ    ‚îú‚îÄ‚îÄ models/
       ‚îÇ    ‚îÇ     ‚îî‚îÄ‚îÄ audio_model.dart
       ‚îÇ    ‚îî‚îÄ‚îÄ repositories/
       ‚îÇ          ‚îî‚îÄ‚îÄ audio_repository.dart
       ‚îÇ
       ‚îú‚îÄ‚îÄ bloc/
       ‚îÇ    ‚îú‚îÄ‚îÄ audio_bloc.dart
       ‚îÇ    ‚îú‚îÄ‚îÄ audio_event.dart
       ‚îÇ    ‚îî‚îÄ‚îÄ audio_state.dart
       ‚îÇ
       ‚îî‚îÄ‚îÄ presentation/
            ‚îú‚îÄ‚îÄ audio_page.dart
            ‚îî‚îÄ‚îÄ audio_player_manager.dart
        </div>

        <h2>‚öôÔ∏è 3. IMPL√âMENTATION √âTAPE PAR √âTAPE</h2>
        
        <div class="step-box">
            <span class="step-number">1</span>
            <strong>Installation des Packages Audio</strong>
            <p>Installation des d√©pendances n√©cessaires pour la lecture audio :</p>
            <pre><code>dependencies:
  just_audio: ^0.9.36          # Lecteur audio principal
  audio_service: ^0.18.12      # Service audio en arri√®re-plan
  rxdart: ^0.27.7             # Gestion des streams</code></pre>
            
            <div class="info-box">
                <strong>Pourquoi ces packages :</strong>
                <ul>
                    <li><code>just_audio</code> : Lecteur audio moderne et performant</li>
                    <li><code>audio_service</code> : Permet la lecture en arri√®re-plan</li>
                    <li><code>rxdart</code> : Gestion des flux de donn√©es audio</li>
                </ul>
            </div>
        </div>

        <div class="step-box">
            <span class="step-number">2</span>
            <strong>Mod√®le de Donn√©es AudioModel</strong>
            <pre><code>// features/audios/data/models/audio_model.dart
class AudioModel {
  final String id;
  final String titre;
  final String artiste;
  final String album;
  final String genre;
  final String description;
  final String audioFileName;
  final String imageFileName;
  final DateTime uploadedAt;
  final int duration;
  final int playCount;

  AudioModel({
    required this.id,
    required this.titre,
    required this.artiste,
    // ... autres champs
  });

  factory AudioModel.fromJson(Map&lt;String, dynamic&gt; json) {
    return AudioModel(
      id: json['_id'] ?? '',
      titre: json['titre'] ?? '',
      artiste: json['artiste'] ?? '',
      // ... mapping complet
    );
  }

  // M√©thodes utilitaires
  String getImageUrl() {
    return 'http://10.0.2.2:5000/uploads/images/$imageFileName';
  }

  String getAudioUrl() {
    return 'http://10.0.2.2:5000/uploads/audios/$audioFileName';
  }

  String getFormattedDuration() {
    if (duration == 0) return "Dur√©e inconnue";
    int minutes = duration ~/ 60;
    int seconds = duration % 60;
    return "${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}";
  }
}</code></pre>
            
            <div class="warning-box">
                <strong>Points d'attention :</strong>
                <ul>
                    <li>Mapping exact avec les champs MongoDB</li>
                    <li>Gestion des URLs compl√®tes pour images et audios</li>
                    <li>Formatage de la dur√©e pour l'affichage</li>
                </ul>
            </div>
        </div>

        <div class="step-box">
            <span class="step-number">3</span>
            <strong>Service API</strong>
            <pre><code>// features/audios/data/datasources/audio_api_service.dart
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../../../../core/api_constants.dart';
import '../models/audio_model.dart';

class AudioApiService {
  Future&lt;List&lt;AudioModel&gt;&gt; getAudios() async {
    try {
      final response = await http.get(
        Uri.parse("${ApiConstants.baseUrl}/audios"),
      );

      if (response.statusCode == 200) {
        final List&lt;dynamic&gt; data = json.decode(response.body);
        return data.map((json) =&gt; AudioModel.fromJson(json)).toList();
      } else {
        throw Exception("Erreur serveur: ${response.statusCode}");
      }
    } catch (e) {
      throw Exception("Erreur de connexion: $e");
    }
  }
}</code></pre>
        </div>

        <div class="step-box">
            <span class="step-number">4</span>
            <strong>Repository</strong>
            <pre><code>// features/audios/data/repositories/audio_repository.dart
class AudioRepository {
  final AudioApiService apiService;

  AudioRepository(this.apiService);

  Future&lt;List&lt;AudioModel&gt;&gt; getAudios() async {
    try {
      return await apiService.getAudios();
    } catch (e) {
      throw Exception("Impossible de r√©cup√©rer les audios: $e");
    }
  }
}</code></pre>
        </div>

        <div class="step-box">
            <span class="step-number">5</span>
            <strong>BLoC (Events, States, Logique)</strong>
            
            <h4>Events :</h4>
            <pre><code>// audio_event.dart
abstract class AudioEvent {}
class LoadAudiosEvent extends AudioEvent {}</code></pre>

            <h4>States :</h4>
            <pre><code>// audio_state.dart
abstract class AudioState {}
class AudioInitial extends AudioState {}
class AudioLoading extends AudioState {}
class AudioLoaded extends AudioState {
  final List&lt;AudioModel&gt; audios;
  AudioLoaded(this.audios);
}
class AudioError extends AudioState {
  final String message;
  AudioError(this.message);
}</code></pre>

            <h4>BLoC :</h4>
            <pre><code>// audio_bloc.dart
class AudioBloc extends Bloc&lt;AudioEvent, AudioState&gt; {
  final AudioRepository repository;

  AudioBloc(this.repository) : super(AudioInitial()) {
    on&lt;LoadAudiosEvent&gt;((event, emit) async {
      emit(AudioLoading());
      try {
        final audios = await repository.getAudios();
        emit(AudioLoaded(audios));
      } catch (e) {
        emit(AudioError(e.toString()));
      }
    });
  }
}</code></pre>
        </div>

        <div class="step-box">
            <span class="step-number">6</span>
            <strong>Configuration main.dart</strong>
            <pre><code>// main.dart
MultiBlocProvider(
  providers: [
    BlocProvider(create: (_) =&gt; UserBloc(...)),
    BlocProvider(create: (_) =&gt; CategoryBloc(...)),
    BlocProvider(create: (_) =&gt; LivreBloc(...)),
    BlocProvider(create: (_) =&gt; AudioBloc(AudioRepository(AudioApiService()))), // NOUVEAU
  ],
  child: MyApp(),
)</code></pre>
            
            <div class="warning-box">
                <strong>IMPORTANT :</strong> Apr√®s modification du main.dart, toujours faire un Hot Restart (Ctrl+Shift+F5)
            </div>
        </div>

        <div class="step-box">
            <span class="step-number">7</span>
            <strong>Gestionnaire Audio R√©el</strong>
            <pre><code>// audio_player_manager.dart
import 'package:just_audio/just_audio.dart';

class AudioPlayerManager {
  static final AudioPlayerManager _instance = AudioPlayerManager._internal();
  factory AudioPlayerManager() =&gt; _instance;
  AudioPlayerManager._internal();

  final AudioPlayer _player = AudioPlayer();
  AudioModel? currentAudio;
  
  AudioPlayer get player =&gt; _player;

  Future&lt;void&gt; playAudio(AudioModel audio) async {
    try {
      currentAudio = audio;
      await _player.setUrl(audio.getAudioUrl());
      await _player.play();
    } catch (e) {
      print('Erreur lecture audio: $e');
    }
  }

  Future&lt;void&gt; pause() async =&gt; await _player.pause();
  Future&lt;void&gt; resume() async =&gt; await _player.play();
  Future&lt;void&gt; stop() async {
    await _player.stop();
    currentAudio = null;
  }
  Future&lt;void&gt; seek(Duration position) async =&gt; await _player.seek(position);
}</code></pre>
        </div>

        <div class="step-box">
            <span class="step-number">8</span>
            <strong>Interface Utilisateur Style Kanguka</strong>
            <p>Page principale avec design sombre et lecteur int√©gr√© en bas :</p>
            
            <h4>Caract√©ristiques du design :</h4>
            <ul>
                <li>Fond sombre (#1E1E2E)</li>
                <li>Liste des audios avec images circulaires</li>
                <li>Lecteur audio fixe en bas</li>
                <li>Barre de progression interactive</li>
                <li>Contr√¥les play/pause/skip/close</li>
            </ul>
        </div>

        <h2>üö® 4. PROBL√àMES RENCONTR√âS ET SOLUTIONS</h2>

        <div class="error-box">
            <h3>Probl√®me 1 : "Cleartext HTTP traffic not permitted"</h3>
            <strong>Sympt√¥me :</strong> L'audio ne se lance pas, erreurs 404 dans les logs
            <br><strong>Cause :</strong> Android bloque les connexions HTTP non s√©curis√©es
            <br><strong>Solution :</strong> Ajouter dans AndroidManifest.xml :
            <pre><code>&lt;application
    android:usesCleartextTraffic="true"&gt;</code></pre>
            <strong>Action requise :</strong> Reconstruction compl√®te de l'APK, pas juste hot restart
        </div>

        <div class="error-box">
            <h3>Probl√®me 2 : Dur√©e 00:00 et barre de progression inactive</h3>
            <strong>Sympt√¥me :</strong> Interface affich√©e mais pas de son, dur√©e √† z√©ro
            <br><strong>Cause :</strong> Lecteur audio ne peut pas acc√©der aux fichiers
            <br><strong>Solution :</strong> V√©rifier la configuration cleartext + red√©marrage app complet
        </div>

        <div class="error-box">
            <h3>Probl√®me 3 : Diff√©rence √©mulateur vs t√©l√©phone physique</h3>
            <strong>Sympt√¥me :</strong> Fonctionne sur √©mulateur mais pas sur t√©l√©phone
            <br><strong>Cause :</strong> Adresse 10.0.2.2 sp√©cifique √©mulateur
            <br><strong>Solution :</strong> Utiliser l'IP locale du PC (ex: 192.168.1.6)
        </div>

        <h2>üì± 5. D√âPLOIEMENT SUR T√âL√âPHONE PHYSIQUE</h2>
        
        <div class="step-box">
            <span class="step-number">1</span>
            <strong>Trouver l'IP du PC</strong>
            <pre><code>ipconfig  # Windows
ifconfig  # Mac/Linux</code></pre>
            Exemple de r√©sultat : 192.168.1.6
        </div>

        <div class="step-box">
            <span class="step-number">2</span>
            <strong>Modifier ApiConstants</strong>
            <pre><code>class ApiConstants {
  static String get baseUrl {
    // D√©tection automatique √©mulateur vs physique
    try {
      final result = InternetAddress.lookup('10.0.2.2');
      return "http://10.0.2.2:5000/api";  // √âmulateur
    } catch (e) {
      return "http://192.168.1.6:5000/api";  // T√©l√©phone physique
    }
  }
}</code></pre>
        </div>

        <div class="step-box">
            <span class="step-number">3</span>
            <strong>G√©n√©rer et installer l'APK</strong>
            <pre><code>flutter build apk --release</code></pre>
            APK g√©n√©r√© dans : <code>build/app/outputs/flutter-apk/app-release.apk</code>
        </div>

        <h2>üåê 6. D√âPLOIEMENT POUR UTILISATEURS DISTANTS</h2>
        
        <div class="info-box">
            <strong>D√©fi :</strong> Envoyer l'APK √† quelqu'un qui n'est pas sur le m√™me r√©seau WiFi
            <br><strong>Probl√®me :</strong> L'IP locale 192.168.1.6 n'est pas accessible depuis internet
        </div>

        <h3>Solutions possibles :</h3>
        
        <table>
            <tr>
                <th>Solution</th>
                <th>Complexit√©</th>
                <th>Co√ªt</th>
                <th>Cas d'usage</th>
            </tr>
            <tr>
                <td><strong>ngrok</strong></td>
                <td>Facile</td>
                <td>Gratuit</td>
                <td>Tests temporaires</td>
            </tr>
            <tr>
                <td><strong>Railway/Render</strong></td>
                <td>Moyenne</td>
                <td>Gratuit limit√©</td>
                <td>D√©ploiement permanent</td>
            </tr>
            <tr>
                <td><strong>VPS d√©di√©</strong></td>
                <td>Difficile</td>
                <td>Payant</td>
                <td>Production</td>
            </tr>
            <tr>
                <td><strong>Donn√©es statiques</strong></td>
                <td>Moyenne</td>
                <td>Gratuit</td>
                <td>Demo sans backend</td>
            </tr>
        </table>

        <h3>Exemple avec ngrok (solution rapide) :</h3>
        <div class="step-box">
            <span class="step-number">1</span>
            <strong>Installer ngrok</strong>
            <br>T√©l√©charger depuis ngrok.com
        </div>

        <div class="step-box">
            <span class="step-number">2</span>
            <strong>Cr√©er un tunnel</strong>
            <pre><code>ngrok http 5000</code></pre>
            R√©sultat : https://abc123.ngrok.io
        </div>

        <div class="step-box">
            <span class="step-number">3</span>
            <strong>Modifier ApiConstants</strong>
            <pre><code>static const String baseUrl = "https://abc123.ngrok.io/api";</code></pre>
        </div>

        <h2>üìä 7. FLUX DE DONN√âES COMPLET</h2>
        
        <div class="flow-diagram">
            <strong>1. D√©marrage App</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>2. LoadAudiosEvent d√©clench√©</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>3. AudioBloc ‚Üí AudioLoading</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>4. Repository ‚Üí ApiService ‚Üí HTTP GET</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>5. Backend MongoDB ‚Üí JSON Response</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>6. Parsing JSON ‚Üí List&lt;AudioModel&gt;</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>7. AudioLoaded ‚Üí UI Rebuild</strong><br>
            <div class="flow-arrow">‚Üì</div>
            <strong>8. Affichage Liste + Lecteur Audio</strong>
        </div>

        <h2>‚úÖ 8. CHECKLIST DE VALIDATION</h2>
        
        <div class="success-box">
            <strong>Backend :</strong>
            <ul>
                <li>Serveur Node.js d√©marr√© sur port 5000</li>
                <li>Route GET /api/audios fonctionnelle</li>
                <li>Fichiers audio dans uploads/audios/</li>
                <li>Images dans uploads/images/</li>
                <li>express.static('/uploads') configur√©</li>
            </ul>
        </div>

        <div class="success-box">
            <strong>Mobile :</strong>
            <ul>
                <li>Packages just_audio install√©s</li>
                <li>Architecture compl√®te (model, service, repository, bloc)</li>
                <li>AudioBloc ajout√© dans main.dart</li>
                <li>Page audio avec design Kanguka</li>
                <li>Gestionnaire audio r√©el impl√©ment√©</li>
                <li>android:usesCleartextTraffic="true" dans AndroidManifest</li>
            </ul>
        </div>

        <div class="success-box">
            <strong>R√©seau :</strong>
            <ul>
                <li>IP correcte selon appareil (10.0.2.2 vs IP locale)</li>
                <li>M√™me r√©seau WiFi pour tests locaux</li>
                <li>URLs test√©es dans navigateur</li>
                <li>Firewall autorise connexions</li>
            </ul>
        </div>

        <h2>üéØ 9. R√âSULTAT FINAL</h2>
        
        <div class="info-box">
            <strong>Fonctionnalit√©s obtenues :</strong>
            <ul>
                <li><strong>Liste audio dynamique :</strong> R√©cup√©ration depuis MongoDB</li>
                <li><strong>Design moderne :</strong> Interface sombre style Kanguka</li>
                <li><strong>Lecteur int√©gr√© :</strong> Lecture audio r√©elle avec contr√¥les</li>
                <li><strong>Barre de progression :</strong> Affichage temps et navigation</li>
                <li><strong>Images de couverture :</strong> Chargement depuis serveur</li>
                <li><strong>Architecture clean :</strong> Code maintenable et extensible</li>
                <li><strong>D√©ploiement flexible :</strong> √âmulateur et t√©l√©phone physique</li>
            </ul>
        </div>

        <h2>üìù 10. NOTES POUR FUTURS PROJETS</h2>
        
        <div class="warning-box">
            <strong>Le√ßons importantes √† retenir :</strong>
            <ul>
                <li><strong>AndroidManifest :</strong> Modifications n√©cessitent rebuild complet</li>
                <li><strong>IP r√©seau :</strong> Diff√©rence √©mulateur/physique critique</li>
                <li><strong>Packages audio :</strong> just_audio plus stable que flutter_sound</li>
                <li><strong>Architecture :</strong> Ordre d'impl√©mentation Model ‚Üí Service ‚Üí Repository ‚Üí BLoC ‚Üí UI</li>
                <li><strong>Tests r√©seau :</strong> Toujours tester URLs dans navigateur d'abord</li>
                <li><strong>D√©ploiement distant :</strong> Pr√©voir solution tunnel ou h√©bergement cloud</li>
            </ul>
        </div>

        <div class="info-box">
            <strong>Ce guide peut servir de r√©f√©rence pour :</strong>
            <ul>
                <li>Impl√©menter d'autres types de m√©dias (vid√©os, podcasts)</li>
                <li>Comprendre l'int√©gration backend-mobile avec lecteur</li>
                <li>Appliquer l'architecture Clean √† des features multimedia</li>
                <li>R√©soudre les probl√®mes de d√©ploiement multi-plateforme</li>
                <li>Former d'autres d√©veloppeurs sur cette stack audio</li>
            </ul>
        </div>
    </div>
</body>
</html>