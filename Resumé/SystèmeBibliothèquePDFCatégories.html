<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Complet - Syst√®me de Biblioth√®que PDF</title>
    <style>
        @media print {
            body { margin: 0; }
            .page-break { page-break-after: always; }
            .no-print { display: none; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #1e40af;
            margin-top: 30px;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(90deg, #dbeafe 0%, transparent 100%);
            border-left: 4px solid #2563eb;
        }
        
        h3 {
            color: #374151;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .success-box {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .error-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            color: #dc2626;
            font-size: 0.9em;
        }
        
        pre code {
            background: none;
            color: #e5e7eb;
            padding: 0;
        }
        
        .architecture-diagram {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .checklist {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .checklist input[type="checkbox"] {
            margin-right: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f3f4f6;
            font-weight: bold;
        }
        
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .flow-step {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            position: relative;
        }
        
        .flow-step::after {
            content: "‚Üì";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #3b82f6;
        }
        
        .flow-step:last-child::after {
            display: none;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö GUIDE COMPLET : Syst√®me de Biblioth√®que PDF avec Cat√©gories</h1>
        
        <div class="info-box">
            <strong>Objectif :</strong> Cr√©er un syst√®me complet de gestion de biblioth√®que num√©rique avec upload de PDFs, cat√©gorisation multiple, et interface d'administration moderne.
        </div>

        <h2><span class="emoji">üéØ</span>1. ARCHITECTURE GLOBALE</h2>
        
        <div class="architecture-diagram">
            <strong>FRONTEND (React.js)</strong><br>
            ‚Üì API REST ‚Üì<br>
            <strong>BACKEND (Node.js + Express + Multer)</strong><br>
            ‚Üì Mongoose ODM ‚Üì<br>
            <strong>DATABASE (MongoDB)</strong> + <strong>FILE SYSTEM</strong><br>
            <br>
            Collections: users | audios | <span class="highlight">categories</span> | <span class="highlight">livres</span>
        </div>

        <h3>Nouveaut√©s par rapport au syst√®me audio :</h3>
        <ul>
            <li><strong>Relations Many-to-Many :</strong> Un livre peut avoir plusieurs cat√©gories</li>
            <li><strong>Gestion de PDFs :</strong> Au lieu de fichiers audio</li>
            <li><strong>Double affichage :</strong> Vue table ET vue grille</li>
            <li><strong>Cat√©gories avec images :</strong> Chaque cat√©gorie a sa propre image</li>
        </ul>

        <h2><span class="emoji">üì¶</span>2. STRUCTURE DES DONN√âES</h2>
        
        <h3>Collection Categories</h3>
        <pre><code>// models/Category.js
const CategorySchema = new mongoose.Schema({
  nom: { type: String, required: true, unique: true },
  description: { type: String },
  
  // Image de la cat√©gorie
  imageFileName: { type: String, required: true },
  imageOriginalName: { type: String, required: true },
  imagePath: { type: String, required: true },
  imageSize: { type: Number, required: true },
  imageMimeType: { type: String, required: true },
  
  createdAt: { type: Date, default: Date.now },
  isActive: { type: Boolean, default: true }
});</code></pre>

        <h3>Collection Livres</h3>
        <pre><code>// models/Livre.js
const LivreSchema = new mongoose.Schema({
  // Informations de base
  titre: { type: String, required: true },
  auteur: { type: String, required: true },
  description: { type: String },
  
  // Relations (Many-to-Many)
  categories: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Category'
  }],
  
  // Fichier PDF
  pdfFileName: { type: String, required: true },
  pdfOriginalName: { type: String, required: true },
  pdfPath: { type: String, required: true },
  pdfSize: { type: Number, required: true },
  pdfMimeType: { type: String, required: true },
  
  // Image de couverture
  imageFileName: { type: String, required: true },
  imageOriginalName: { type: String, required: true },
  imagePath: { type: String, required: true },
  imageSize: { type: Number, required: true },
  imageMimeType: { type: String, required: true },
  
  // M√©tadonn√©es
  uploadedBy: { type: ObjectId, ref: 'User' },
  uploadedAt: { type: Date, default: Date.now },
  downloadCount: { type: Number, default: 0 },
  isActive: { type: Boolean, default: true }
});</code></pre>

        <div class="page-break"></div>

        <h2><span class="emoji">üõ†Ô∏è</span>3. CONFIGURATION BACKEND</h2>
        
        <h3>A. Configuration Multer pour multiples types de fichiers</h3>
        <pre><code>// config/multerConfig.js
const storage = multer.diskStorage({
  destination: function(req, file, cb) {
    if (file.fieldname === 'audio') {
      cb(null, 'uploads/audios/');
    } else if (file.fieldname === 'image') {
      // D√©tection intelligente selon la route
      if (req.url.includes('categories')) {
        cb(null, 'uploads/categories/');
      } else {
        cb(null, 'uploads/images/');
      }
    } else if (file.fieldname === 'pdf') {
      cb(null, 'uploads/livres/');
    }
  },
  
  filename: function(req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

const fileFilter = (req, file, cb) => {
  if (file.fieldname === 'pdf') {
    if (file.mimetype === 'application/pdf') {
      cb(null, true);
    } else {
      cb(new Error('Format PDF uniquement'), false);
    }
  }
  // ... autres validations
};</code></pre>

        <h3>B. Routes Categories avec protection</h3>
        <pre><code>// routes/categories.js

// POST - Cr√©er une cat√©gorie
router.post('/create', upload.single('image'), async (req, res) => {
  // V√©rification des doublons
  const existingCategory = await Category.findOne({ nom: req.body.nom });
  if (existingCategory) {
    fs.unlinkSync(req.file.path); // Nettoyer le fichier upload√©
    return res.status(400).json({ message: 'Cette cat√©gorie existe d√©j√†' });
  }
  // ... cr√©ation
});

// DELETE - Avec v√©rification des d√©pendances
router.delete('/:id', async (req, res) => {
  // V√©rifier si des livres utilisent cette cat√©gorie
  const livresAvecCategorie = await Livre.countDocuments({ 
    categories: req.params.id 
  });
  
  if (livresAvecCategorie > 0) {
    return res.status(400).json({ 
      message: `Impossible de supprimer : ${livresAvecCategorie} livre(s) utilisent cette cat√©gorie` 
    });
  }
  // ... suppression
});</code></pre>

        <h3>C. Routes Livres avec gestion des cat√©gories multiples</h3>
        <pre><code>// routes/livres.js

// POST - Upload avec cat√©gories multiples
router.post('/upload', upload.fields([
  { name: 'pdf', maxCount: 1 },
  { name: 'image', maxCount: 1 }
]), async (req, res) => {
  // Gestion des cat√©gories (peut √™tre un tableau)
  let categoriesArray = [];
  if (req.body.categories) {
    if (typeof req.body.categories === 'string') {
      categoriesArray = [req.body.categories];
    } else {
      categoriesArray = req.body.categories;
    }
  }
  
  const newLivre = new Livre({
    // ... autres champs
    categories: categoriesArray  // Tableau d'ObjectIds
  });
});

// GET - Avec populate pour r√©cup√©rer les d√©tails des cat√©gories
router.get('/', async (req, res) => {
  const livres = await Livre.find({ isActive: true })
    .populate('categories', 'nom')  // Important : populate les cat√©gories
    .populate('uploadedBy', 'name email')
    .sort({ uploadedAt: -1 });
});</code></pre>

        <div class="page-break"></div>

        <h2><span class="emoji">üé®</span>4. IMPL√âMENTATION FRONTEND</h2>
        
        <h3>A. Services API</h3>
        <pre><code>// services/api.js

// Categories
export async function getCategories() {
  const res = await fetch('/api/categories');
  if (!res.ok) throw new Error('Erreur r√©seau');
  return res.json();
}

export async function createCategory(formData) {
  const res = await fetch('/api/categories/create', {
    method: 'POST',
    body: formData  // FormData car image
  });
  if (!res.ok) throw new Error('Erreur cr√©ation');
  return res.json();
}

// Livres
export async function getLivres() {
  const res = await fetch('/api/livres');
  if (!res.ok) throw new Error('Erreur r√©seau');
  return res.json();
}

export async function uploadLivre(formData) {
  const res = await fetch('/api/livres/upload', {
    method: 'POST',
    body: formData  // FormData car PDF + image
  });
  if (!res.ok) throw new Error('Erreur upload');
  return res.json();
}</code></pre>

        <h3>B. Composant Categories avec upload d'image</h3>
        <pre><code>// pages/CategorieLivresPage.jsx
const CategorieLivresPage = () => {
  const [categories, setCategories] = useState([]);
  const [imageFile, setImageFile] = useState(null);
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const data = new FormData();
    data.append('nom', formData.nom);
    data.append('description', formData.description);
    data.append('image', imageFile);  // ‚Üê Fichier image
    
    try {
      await createCategory(data);
      fetchCategories(); // Recharger la liste
    } catch (error) {
      alert('Erreur lors de la cr√©ation');
    }
  };
  
  // Affichage avec URL compl√®te pour l'image
  &lt;img 
    src={`http://localhost:5000/${cat.imagePath}`}
    alt={cat.nom}
    onError={(e) => {
      e.target.src = 'https://via.placeholder.com/60';
    }}
  /&gt;
};</code></pre>

        <h3>C. Composant Livres avec double vue</h3>
        <pre><code>// pages/AdminBooks.jsx
const AdminBooks = () => {
  const [viewMode, setViewMode] = useState('table'); // 'table' | 'grid'
  const [books, setBooks] = useState([]);
  const [categories, setCategories] = useState([]);
  
  // Chargement parall√®le des donn√©es
  useEffect(() => {
    Promise.all([getLivres(), getCategories()])
      .then(([livresData, categoriesData]) => {
        setBooks(livresData);
        setCategories(categoriesData);
      });
  }, []);
  
  // Gestion des cat√©gories peupl√©es ou IDs
  const getCategoryNames = (bookCategories) => {
    if (!bookCategories || bookCategories.length === 0) return 'Non class√©';
    
    // Si les cat√©gories sont d√©j√† peupl√©es (objets)
    if (typeof bookCategories[0] === 'object' && bookCategories[0].nom) {
      return bookCategories.map(cat => cat.nom).join(', ');
    }
    
    // Si ce sont des IDs
    const names = bookCategories.map(catId => {
      const cat = categories.find(c => c._id === catId);
      return cat ? cat.nom : '';
    }).filter(name => name);
    
    return names.join(', ');
  };
  
  // Switch entre vue table et grille
  {viewMode === 'table' && &lt;TableView /&gt;}
  {viewMode === 'grid' && &lt;GridView /&gt;}
};</code></pre>

        <div class="page-break"></div>

        <h2><span class="emoji">üîÑ</span>5. FLUX DE DONN√âES COMPLET</h2>
        
        <div class="flow-diagram">
            <div class="flow-step">
                <strong>1. CR√âATION DE CAT√âGORIE</strong><br>
                Admin upload nom + image ‚Üí FormData ‚Üí POST /api/categories/create
            </div>
            <div class="flow-step">
                <strong>2. STOCKAGE CAT√âGORIE</strong><br>
                Multer sauvegarde image dans /uploads/categories/ ‚Üí MongoDB stocke m√©tadonn√©es
            </div>
            <div class="flow-step">
                <strong>3. UPLOAD DE LIVRE</strong><br>
                Admin s√©lectionne PDF + image + cat√©gories[] ‚Üí FormData
            </div>
            <div class="flow-step">
                <strong>4. TRAITEMENT LIVRE</strong><br>
                Multer: PDF ‚Üí /uploads/livres/, Image ‚Üí /uploads/images/
            </div>
            <div class="flow-step">
                <strong>5. RELATIONS MONGODB</strong><br>
                Livre.categories = [ObjectId, ObjectId...] ‚Üí R√©f√©rences vers categories
            </div>
            <div class="flow-step">
                <strong>6. R√âCUP√âRATION AVEC POPULATE</strong><br>
                GET /api/livres avec .populate('categories') ‚Üí Transforme IDs en objets
            </div>
            <div class="flow-step">
                <strong>7. AFFICHAGE FRONTEND</strong><br>
                Vue table ou grille, filtrage par cat√©gorie, t√©l√©chargement PDF
            </div>
        </div>

        <h2><span class="emoji">üí°</span>6. POINTS CL√âS ET DIFF√âRENCES</h2>
        
        <table>
            <tr>
                <th>Aspect</th>
                <th>Syst√®me Audio</th>
                <th>Syst√®me Livres</th>
            </tr>
            <tr>
                <td><strong>Relations</strong></td>
                <td>One-to-One (1 audio, 1 image)</td>
                <td>Many-to-Many (livres ‚Üî cat√©gories)</td>
            </tr>
            <tr>
                <td><strong>Fichier principal</strong></td>
                <td>Audio (MP3, WAV)</td>
                <td>Document (PDF)</td>
            </tr>
            <tr>
                <td><strong>Cat√©gorisation</strong></td>
                <td>Simple string ou non existant</td>
                <td>Collection s√©par√©e avec images</td>
            </tr>
            <tr>
                <td><strong>Affichage</strong></td>
                <td>Cartes uniquement</td>
                <td>Table + Grille (double vue)</td>
            </tr>
            <tr>
                <td><strong>Populate</strong></td>
                <td>User uniquement</td>
                <td>Categories + User</td>
            </tr>
            <tr>
                <td><strong>Protection</strong></td>
                <td>Suppression simple</td>
                <td>V√©rification des d√©pendances</td>
            </tr>
        </table>

        <h2><span class="emoji">‚ö†Ô∏è</span>7. GESTION DES ERREURS COMMUNES</h2>
        
        <div class="error-box">
            <strong>Probl√®me : Cat√©gories affichent "Non class√©"</strong><br>
            <strong>Solution :</strong> V√©rifier que .populate('categories', 'nom') est pr√©sent dans la route GET
        </div>
        
        <div class="error-box">
            <strong>Probl√®me : Images dans mauvais dossier</strong><br>
            <strong>Solution :</strong> Multer v√©rifie req.url pour d√©terminer destination
        </div>
        
        <div class="error-box">
            <strong>Probl√®me : Encodage UTF-8 (accents)</strong><br>
            <strong>Solution :</strong> res.setHeader('Content-Type', 'application/json; charset=utf-8')
        </div>
        
        <div class="error-box">
            <strong>Probl√®me : Tableau d√©borde (overflow)</strong><br>
            <strong>Solution :</strong> tableContainer: { overflow: 'auto' }
        </div>

        <div class="page-break"></div>

        <h2><span class="emoji">‚úÖ</span>8. CHECKLIST DE VALIDATION</h2>
        
        <div class="checklist">
            <h3>Backend</h3>
            <label><input type="checkbox"> Collections MongoDB cr√©√©es (categories, livres)</label><br>
            <label><input type="checkbox"> Mod√®les avec relations configur√©es</label><br>
            <label><input type="checkbox"> Multer avec destinations multiples</label><br>
            <label><input type="checkbox"> Routes avec populate pour les GET</label><br>
            <label><input type="checkbox"> Protection suppression cat√©gories utilis√©es</label><br>
            <label><input type="checkbox"> Middleware express.static pour servir les fichiers</label>
            
            <h3>Frontend</h3>
            <label><input type="checkbox"> Services API pour categories et livres</label><br>
            <label><input type="checkbox"> Page cat√©gories avec formulaire upload</label><br>
            <label><input type="checkbox"> Page livres avec double vue (table/grille)</label><br>
            <label><input type="checkbox"> Modal upload livre avec s√©lection cat√©gories multiples</label><br>
            <label><input type="checkbox"> Gestion des cat√©gories peupl√©es vs IDs</label><br>
            <label><input type="checkbox"> Filtrage et recherche fonctionnels</label><br>
            <label><input type="checkbox"> URLs correctes pour images et PDFs</label>
            
            <h3>Tests</h3>
            <label><input type="checkbox"> Cr√©ation cat√©gorie avec image</label><br>
            <label><input type="checkbox"> Upload livre avec PDF + image + cat√©gories</label><br>
            <label><input type="checkbox"> Affichage correct des cat√©gories dans les livres</label><br>
            <label><input type="checkbox"> T√©l√©chargement PDF fonctionnel</label><br>
            <label><input type="checkbox"> Suppression avec v√©rification d√©pendances</label><br>
            <label><input type="checkbox"> Switch vue table/grille</label><br>
            <label><input type="checkbox"> Filtrage par cat√©gorie</label>
        </div>

        <h2><span class="emoji">üìà</span>9. AM√âLIORATIONS FUTURES</h2>
        
        <div class="success-box">
            <strong>Fonctionnalit√©s √† ajouter :</strong>
            <ul>
                <li><strong>Lecteur PDF int√©gr√© :</strong> Utiliser pdf.js pour afficher les PDFs dans l'app</li>
                <li><strong>Pagination :</strong> Pour g√©rer de grandes collections</li>
                <li><strong>√âdition :</strong> Modifier les infos d'un livre existant</li>
                <li><strong>Tags :</strong> Syst√®me de tags en plus des cat√©gories</li>
                <li><strong>Favoris :</strong> Permettre aux utilisateurs de marquer des favoris</li>
                <li><strong>Recherche avanc√©e :</strong> Par date, taille, nombre de pages</li>
                <li><strong>Export :</strong> Exporter la liste en CSV/Excel</li>
                <li><strong>Statistiques :</strong> Graphiques des t√©l√©chargements par cat√©gorie</li>
            </ul>
        </div>

        <h2><span class="emoji">üéØ</span>10. COMMANDES ESSENTIELLES</h2>
        
        <pre><code># Installation des d√©pendances Backend
npm install express mongoose multer cors dotenv

# Installation des d√©pendances Frontend  
npm install react-icons

# Structure des dossiers √† cr√©er
mkdir -p uploads/audios uploads/images uploads/categories uploads/livres
mkdir -p models routes config

# Test avec Postman
POST http://localhost:5000/api/categories/create (form-data: nom, description, image)
POST http://localhost:5000/api/livres/upload (form-data: titre, auteur, categories[], pdf, image)
GET http://localhost:5000/api/livres
GET http://localhost:5000/api/categories</code></pre>

        <div class="info-box">
            <strong>Conclusion :</strong> Ce syst√®me de biblioth√®que est une √©volution du syst√®me audio, ajoutant la gestion de documents PDF, des cat√©gories avec images, et des relations many-to-many. L'architecture reste modulaire et extensible pour de futures am√©liorations.
        </div>
    </div>
</body>
</html>